name: Update README

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 * * * *"   # 每小時執行一次

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Update Recent Activity
        uses: jamesgeorge007/github-activity-readme@v0.4.1
        with:
          COMMIT_MSG: "chore: update README with recent activity"
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}

      - name: Update Recent Commits & PRs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.REPO_TOKEN }}
          script: |
            const fs = require('fs');
            const readme = fs.readFileSync('README.md','utf8');

            // --- Recent Commits ---
            const { data: commits } = await github.request(
              'GET /repos/{owner}/{repo}/commits',
              { owner: context.repo.owner, repo: context.repo.repo, per_page: 5 }
            );
            const commitLines = commits.map(c =>
              `- ${c.commit.message} (${c.sha.substring(0,7)}) by @${c.commit.author.name}`
            ).join('\n');

            // --- Recent PRs ---
            const { data: prs } = await github.request(
              'GET /repos/{owner}/{repo}/pulls',
              { owner: context.repo.owner, repo: context.repo.repo, state: 'closed', per_page: 5 }
            );
            const mergedPRs = prs.filter(p => p.merged_at);
            const prLines = mergedPRs.map(p =>
              `- 🟢 Merged PR [#${p.number}](${p.html_url}) - ${p.title}`
            ).join('\n');

            let newReadme = readme;

            // Replace Commits section
            newReadme = newReadme.replace(
              /<!--START_SECTION:commits-->[\\s\\S]*<!--END_SECTION:commits-->/,
              `<!--START_SECTION:commits-->\n${commitLines}\n<!--END_SECTION:commits-->`
            );

            // Replace PRs section
            newReadme = newReadme.replace(
              /<!--START_SECTION:prs-->[\\s\\S]*<!--END_SECTION:prs-->/,
              `<!--START_SECTION:prs-->\n${prLines}\n<!--END_SECTION:prs-->`
            );

            fs.writeFileSync('README.md', newReadme);
            console.log("✅ README updated with commits & PRs");

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update commits & PRs in README"
